# 📦 バックアップ・復旧ガイド

45人プログラミング学習コミュニティ向けの日程調整システムのバックアップ・復旧手順です。

## 🎯 バックアップ戦略

### なぜバックアップが必要？
- **データ保護**: SQLiteファイル破損、誤操作、サーバー障害からデータを守る
- **安心運用**: 週次利用でも参加者の貴重な回答データを失わない
- **簡単復旧**: 問題発生時に素早く元の状態に戻せる

### 推奨バックアップ頻度
- **週次自動**: 毎週日曜日午前2時（利用前）
- **手動**: イベント作成前、重要な変更前
- **保持期間**: 週次8週間、手動30日間

## 🔧 バックアップ操作

### 手動バックアップ
```bash
# 基本的な手動バックアップ
./scripts/backup.sh manual

# 週次バックアップとして保存
./scripts/backup.sh weekly
```

### 自動バックアップ設定
```bash
# 週次自動バックアップを設定
./scripts/setup-weekly-backup.sh

# 設定確認
crontab -l
```

### バックアップ一覧確認
```bash
# 利用可能なバックアップを表示
./scripts/restore.sh

# バックアップディレクトリを直接確認
ls -la backups/
```

## 🔄 復旧操作

### 基本的な復旧手順
```bash
# 1. 利用可能なバックアップを確認
./scripts/restore.sh

# 2. 特定のバックアップから復旧
./scripts/restore.sh weekly_20251213_020000

# 3. アプリケーション再起動
npm run dev  # または pm2 restart など
```

### 緊急復旧
```bash
# アプリを停止
# 手動でファイルをコピー
cp backups/[バックアップ名]/schedule.db data/
# アプリを再起動
```

## 📊 バックアップ内容

各バックアップには以下が含まれます：

### データファイル
- `schedule.db` - メインのSQLiteデータベース
- `schedule.db-wal` - Write-Ahead Logファイル（存在する場合）
- `schedule.db-shm` - 共有メモリファイル（存在する場合）
- `*.json` - 互換性のためのJSONファイル（存在する場合）

### メタデータ
- `backup_info.txt` - バックアップ情報と統計
  - 作成日時
  - データ統計（イベント数、参加者数など）
  - サーバー情報

## 🛠️ トラブルシューティング

### よくある問題と解決方法

#### バックアップが失敗する
```bash
# SQLiteデータベースの状態確認
sqlite3 data/schedule.db "PRAGMA integrity_check;"

# 権限確認
ls -la data/
chmod 644 data/schedule.db
```

#### 復旧後にデータが表示されない
```bash
# データベース内容確認
sqlite3 data/schedule.db "SELECT COUNT(*) FROM events;"

# アプリケーションのキャッシュクリア
# ブラウザで管理者メニュー → キャッシュクリア
```

#### 自動バックアップが動作しない
```bash
# cron設定確認
crontab -l

# ログ確認
tail -f logs/backup.log

# 手動実行テスト
./scripts/backup.sh weekly
```

## 📈 運用のベストプラクティス

### 定期確認（月1回）
1. バックアップログの確認
2. 復旧テストの実施
3. 古いバックアップの整理確認

### イベント前の準備
1. 手動バックアップの実行
2. データ整合性の確認
3. 参加者への事前案内

### 問題発生時の対応
1. 現状のデータを緊急バックアップ
2. 最新の正常なバックアップから復旧
3. 参加者への状況報告

## 💾 ストレージ使用量

### 概算サイズ（45人コミュニティ）
- 1週間のデータ: 約200KB
- 月間バックアップ: 約1MB
- 年間保存容量: 約50MB

### 容量節約のコツ
- 古いバックアップの自動削除（設定済み）
- 重要でないテストデータの定期削除
- 大きなファイルの圧縮（必要に応じて）

## 🔐 セキュリティ考慮事項

### バックアップファイルの保護
- バックアップディレクトリの権限設定
- 機密情報の取り扱い注意
- 外部ストレージ利用時の暗号化

### アクセス制御
- バックアップスクリプトの実行権限
- 復旧操作の管理者限定
- ログファイルの適切な管理

---

## 📞 サポート

問題が発生した場合：
1. このガイドのトラブルシューティングを確認
2. ログファイル（`logs/backup.log`）を確認
3. 管理者に連絡（緊急時は現状のデータを保護してから）

**重要**: 復旧作業前は必ず現在のデータをバックアップしてください！